<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Markdown with Math Rendering</title>
  <!-- 引入 KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js"></script>
  <!-- 引入 marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- 引入适合浏览器的 highlight.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>

<div id="content"></div>

<script>
  function formateMarkdown(message) {
    var renderer = new marked.Renderer();

    renderer.code = function (code, language) {
      var highlightedCode = hljs.highlightAuto(code).value;
      return (
        '<pre><code class="hljs ' +
        language +
        '">' +
        highlightedCode +
        "</code></pre>"
      );
    };

    marked.setOptions({
      renderer: renderer,
      gfm: true,
      tables: true,
      breaks: true,
      pedantic: false,
      sanitize: false,
      smartLists: true,
      smartypants: false,
      highlight: function (code, language) {
        return hljs.highlightAuto(code).value;
      }
    });

    var html = marked.parse(message);

    var tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;

    renderMathInElement(tempDiv, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\[", right: "\\]", display: true},
        {left: "\\(", right: "\\)", display: false}
      ]
    });

    return tempDiv.innerHTML;
  }

  // 示例 Markdown 内容
  var markdownContent = "这是一个公式：\\(\\frac{d}{d\\theta}L(\\theta | x) = 0\\)。";
  document.getElementById('content').innerHTML = formateMarkdown(markdownContent);
</script>

</body>
</html>
